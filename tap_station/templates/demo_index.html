<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NSW Health Drug Checking Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(135deg, #0066cc 0%, #00cc66 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        padding: 40px 20px;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .header .subtitle {
        font-size: 1.3em;
        opacity: 0.95;
        margin-bottom: 10px;
      }

      .header .demo-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 8px 20px;
        border-radius: 20px;
        margin-top: 10px;
        font-weight: 600;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .intro-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .intro-card h2 {
        color: #0066cc;
        margin-bottom: 15px;
      }

      .intro-card p {
        color: #666;
        line-height: 1.6;
        margin-bottom: 10px;
      }

      .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .feature-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .feature-card .icon {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .feature-card h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.2em;
      }

      .feature-card p {
        color: #666;
        font-size: 0.95em;
        line-height: 1.5;
      }

      .views-section {
        margin-top: 40px;
      }

      .views-section h2 {
        color: white;
        text-align: center;
        margin-bottom: 25px;
        font-size: 2em;
      }

      .view-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .view-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s, box-shadow 0.2s;
        text-decoration: none;
        color: inherit;
        display: block;
      }

      .view-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      }

      .view-card .card-icon {
        font-size: 3em;
        margin-bottom: 15px;
      }

      .view-card h3 {
        color: #0066cc;
        margin-bottom: 10px;
        font-size: 1.5em;
      }

      .view-card .card-subtitle {
        color: #999;
        font-size: 0.9em;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .view-card p {
        color: #666;
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .view-card .btn {
        display: inline-block;
        background: #0066cc;
        color: white;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        margin-top: 10px;
        transition: background 0.2s;
      }

      .view-card:hover .btn {
        background: #0052a3;
      }

      .stats-bar {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 20px;
      }

      .stat {
        text-align: center;
      }

      .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #0066cc;
      }

      .stat-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 20px;
        margin-top: 15px;
      }

      .pulse {
        width: 12px;
        height: 12px;
        background: #00ff00;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
      }

      .footer {
        text-align: center;
        color: white;
        padding: 40px 20px;
        margin-top: 60px;
        opacity: 0.9;
      }

      .footer p {
        margin: 5px 0;
      }

      /* Modal/Notification Styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        font-size: 1.5em;
        margin-bottom: 15px;
        color: #1a1a1a;
      }

      .modal-body {
        color: #333;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      .modal-code {
        background: #f5f5f5;
        padding: 12px;
        border-radius: 6px;
        font-family: monospace;
        margin: 10px 0;
        font-size: 0.9em;
        color: #d63031;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .modal-button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.2s;
      }

      .modal-button.primary {
        background: #0066cc;
        color: white;
      }

      .modal-button.primary:hover {
        background: #0052a3;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8em;
        }

        .view-cards {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üè• NSW Health Drug Checking Service</h1>
      <p class="subtitle">Festival Queue Management System - Live Demo</p>
      <div class="demo-badge" id="scenario-badge">Interactive Demo Environment</div>
      <div class="live-indicator">
        <span class="pulse"></span>
        <span>Live Data Simulation Running</span>
      </div>
    </div>

    <div class="container">
      <div class="intro-card" id="current-scenario-card" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 3px solid #ffd700;">
        <h2 style="color: white; margin-bottom: 15px;">üìç Currently Viewing</h2>
        <h3 id="current-scenario-name" style="color: #ffd700; font-size: 1.8em; margin-bottom: 10px;"></h3>
        <p id="current-scenario-desc" style="font-size: 1.1em; margin-bottom: 15px;"></p>
        <div id="current-scenario-stats" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
          <p style="margin: 5px 0;"><strong>To compare with other scenarios:</strong></p>
          <p style="margin: 5px 0; font-size: 0.95em;">
            ‚Ä¢ <strong>For deployed demo:</strong> Visit the other scenario URLs<br>
            ‚Ä¢ <strong>For local testing:</strong> Stop server (Ctrl+C) and restart with:<br>
            <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px;">python demo_server.py --scenario [scenario_name]</code>
          </p>
        </div>
      </div>

      <div class="intro-card">
        <h2>Welcome to the NSW Health Drug Checking Demo</h2>
        <p>
          This is a live demonstration of an NFC-based queue management system designed specifically
          for drug checking services at music festivals. The system uses NFC tap cards to track
          participants through the service workflow, providing real-time visibility, analytics, and
          operational insights.
        </p>
        <p>
          <strong>This demo is actively simulating festival activity</strong> with realistic participant
          flow, queue dynamics, and service operations. All data shown is generated in real-time for
          demonstration purposes.
        </p>
      </div>

      <div class="stats-bar">
        <div class="stat">
          <div class="stat-value" id="active-count">-</div>
          <div class="stat-label">Active Now</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="queue-count">-</div>
          <div class="stat-label">In Queue</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="total-count">-</div>
          <div class="stat-label">Total Served</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="wait-time">-</div>
          <div class="stat-label">Est. Wait (min)</div>
        </div>
      </div>

      <div class="features">
        <div class="feature-card">
          <div class="icon">üéØ</div>
          <h3>Real-Time Tracking</h3>
          <p>Track every participant's journey from queue entry to service completion with automatic NFC card detection.</p>
        </div>
        <div class="feature-card">
          <div class="icon">üìä</div>
          <h3>Live Analytics</h3>
          <p>Monitor queue length, wait times, service throughput, and operational metrics in real-time.</p>
        </div>
        <div class="feature-card">
          <div class="icon">‚ö†Ô∏è</div>
          <h3>Smart Alerts</h3>
          <p>Automatic detection of stuck cards, long wait times, queue buildups, and station issues.</p>
        </div>
        <div class="feature-card">
          <div class="icon">üîí</div>
          <h3>Privacy First</h3>
          <p>Anonymous token-based tracking with no personal data collection. Export for accountability reporting.</p>
        </div>
      </div>

      <div class="views-section" style="margin-top: 50px;">
        <h2>üé™ Select Festival Scenario</h2>
        <p style="text-align: center; color: white; margin-bottom: 25px; font-size: 1.1em;">
          Compare different deployment scenarios based on real-world NSW festival data
        </p>
        <div class="view-cards">
          <button class="view-card scenario-card" data-scenario="htid" style="border: 3px solid transparent; background: #1a1a1a; width: 100%; text-align: left; cursor: pointer;" aria-label="HTID Hardstyle Til I Die scenario">
            <div class="card-icon">üéµ</div>
            <div class="card-subtitle">SINGLE DAY FESTIVAL</div>
            <h3>HTID (Hardstyle Til I Die)</h3>
            <p style="margin-bottom: 15px;">
              <strong>Manageable demand</strong> - 6 hour operation, moderate arrivals, service met demand
            </p>
            <div style="background: #f7f9fc; padding: 15px; border-radius: 8px; text-align: left; margin: 10px 0; font-size: 0.9em;">
              <div style="margin: 5px 0;"><strong>Staff:</strong> 6 peers, 6 chemists</div>
              <div style="margin: 5px 0;"><strong>Served:</strong> 70 groups, 110 samples</div>
              <div style="margin: 5px 0;"><strong>Peak queue:</strong> ~15 groups</div>
              <div style="margin: 5px 0;"><strong>Max wait:</strong> 30 minutes</div>
              <div style="margin: 5px 0; color: #059669;"><strong>‚úì Outcome:</strong> Success - good experience</div>
            </div>
            <span class="btn" style="background: #10b981;">View This Scenario ‚Üí</span>
          </button>

          <button class="view-card scenario-card" data-scenario="lost_paradise_actual" style="border: 3px solid transparent; background: #1a1a1a; width: 100%; text-align: left; cursor: pointer;" aria-label="Lost Paradise Understaffed scenario">
            <div class="card-icon">üå¥</div>
            <div class="card-subtitle">MULTI-DAY FESTIVAL - ACTUAL</div>
            <h3>Lost Paradise (Understaffed)</h3>
            <p style="margin-bottom: 15px;">
              <strong>CRITICAL capacity crisis</strong> - Same staffing, way more demand. Line out the door, 3hr waits
            </p>
            <div style="background: #fef2f2; padding: 15px; border-radius: 8px; text-align: left; margin: 10px 0; font-size: 0.9em;">
              <div style="margin: 5px 0;"><strong>Staff:</strong> 6 peers, 6 chemists (SAME!)</div>
              <div style="margin: 5px 0;"><strong>Served:</strong> 150 groups, 300 samples (2 days)</div>
              <div style="margin: 5px 0; color: #dc2626;"><strong>Peak queue:</strong> 60+ groups (out the door)</div>
              <div style="margin: 5px 0; color: #dc2626;"><strong>Max wait:</strong> 3 HOURS</div>
              <div style="margin: 5px 0; color: #dc2626;"><strong>‚úó Outcome:</strong> Many turned away, staff burnout</div>
            </div>
            <span class="btn" style="background: #dc2626;">View This Scenario ‚Üí</span>
          </button>

          <button class="view-card scenario-card" data-scenario="lost_paradise_ideal" style="border: 3px solid transparent; background: #1a1a1a; width: 100%; text-align: left; cursor: pointer;" aria-label="Lost Paradise Proper Staffing scenario">
            <div class="card-icon">üåü</div>
            <div class="card-subtitle">MULTI-DAY FESTIVAL - IDEAL</div>
            <h3>Lost Paradise (Proper Staffing)</h3>
            <p style="margin-bottom: 15px;">
              <strong>PROPER resourcing</strong> - Same demand, doubled staff. Everyone served, <30min waits
            </p>
            <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: left; margin: 10px 0; font-size: 0.9em;">
              <div style="margin: 5px 0;"><strong>Staff:</strong> 12 peers, 12 chemists (DOUBLED!)</div>
              <div style="margin: 5px 0;"><strong>Capacity:</strong> 250+ groups, 500+ samples</div>
              <div style="margin: 5px 0; color: #059669;"><strong>Peak queue:</strong> ~20 groups (manageable)</div>
              <div style="margin: 5px 0; color: #059669;"><strong>Max wait:</strong> 45 minutes</div>
              <div style="margin: 5px 0; color: #059669;"><strong>‚úì Outcome:</strong> Success - meets demand, quality service</div>
            </div>
            <span class="btn" style="background: #0066cc;">View This Scenario ‚Üí</span>
          </button>
        </div>
      </div>

      <div class="views-section">
        <h2>üé≠ Explore the Demo Views</h2>
        <div class="view-cards">
          <a href="/public" class="view-card">
            <div class="card-icon">üì∫</div>
            <div class="card-subtitle">For Participants</div>
            <h3>Public Queue Display</h3>
            <p>
              Large-format display designed for tablets/TVs showing current queue position and
              estimated wait times. Participants can see where they are in the queue and when
              to expect service.
            </p>
            <span class="btn">View Public Display ‚Üí</span>
          </a>

          <a href="/dashboard" class="view-card">
            <div class="card-icon">üéõÔ∏è</div>
            <div class="card-subtitle">For Staff</div>
            <h3>Staff Dashboard</h3>
            <p>
              Comprehensive real-time metrics including queue stats, throughput analysis, wait time
              estimates, and operational alerts. Designed for staff monitoring and service optimization.
            </p>
            <span class="btn">View Dashboard ‚Üí</span>
          </a>

          <a href="/monitor" class="view-card">
            <div class="card-icon">üîç</div>
            <div class="card-subtitle">For Staff</div>
            <h3>Activity Monitor</h3>
            <p>
              Live feed of all tap events, participant status tracking, and anomaly detection.
              Identify stuck cards and participants who may need assistance.
            </p>
            <span class="btn">View Monitor ‚Üí</span>
          </a>

          <a href="/control" class="view-card">
            <div class="card-icon">‚öôÔ∏è</div>
            <div class="card-subtitle">For Coordinators</div>
            <h3>Control Panel</h3>
            <p>
              Administrative controls for manual event corrections, force-exit functionality,
              database backup/export, and system configuration. Full audit trail maintained.
            </p>
            <span class="btn">View Control Panel ‚Üí</span>
          </a>

          <a href="/shift" class="view-card">
            <div class="card-icon">üìã</div>
            <div class="card-subtitle">For Staff Handoffs</div>
            <h3>Shift Summary</h3>
            <p>
              Comprehensive shift handoff report with participant counts, service metrics,
              anomalies detected, and current system status. Perfect for volunteer shift changes.
            </p>
            <span class="btn">View Shift Summary ‚Üí</span>
          </a>

          <a href="/check?token=001" class="view-card">
            <div class="card-icon">üé´</div>
            <div class="card-subtitle">For Participants</div>
            <h3>Individual Status Check</h3>
            <p>
              Participants can check their specific card status, see their complete journey through
              the service, and get personalized wait estimates.
            </p>
            <span class="btn">Check Status (Token 001) ‚Üí</span>
          </a>
        </div>
      </div>

      <div class="intro-card" style="margin-top: 40px;">
        <h2>üí° Demo Features</h2>
        <p><strong>Live Data Simulation:</strong> The system continuously generates realistic participant activity based on actual festival data. Simulates quiet start (hour 1), peak queue of ~15 groups (hours 2-3), and quiet finish (hour 6) - matching real-world patterns.</p>
        <p><strong>Realistic Service Times:</strong> Based on actual HTID deployment data - 5min peer intake, 8min chemist testing, 10min results discussion (with variance up to 30+ mins for complex conversations).</p>
        <p><strong>Proven Throughput:</strong> Calibrated to real-world capacity: ~12 groups/hour average with 6 peer workers and 6 chemists serving 70 groups over 6 hours.</p>
        <p><strong>No Hardware Required:</strong> Running in mock mode - no physical NFC readers needed for this demo</p>
        <p><strong>Fully Configurable:</strong> Service workflow, alerts, capacity limits, and UI messages can all be customized via YAML configuration</p>
        <p><strong>Export Ready:</strong> All data can be exported to CSV for reporting and accountability purposes</p>
      </div>

      <div class="footer">
        <p><strong>Questions or Feedback?</strong></p>
        <p>This demo is designed to facilitate workshop discussions about workflow, UI/UX, and operational requirements.</p>
        <p style="margin-top: 20px; opacity: 0.7;">NSW Health Drug Checking Service Demo | 2026</p>
      </div>
    </div>

    <!-- Modal for scenario switching instructions -->
    <div id="scenarioModal" class="modal-overlay" role="dialog" aria-labelledby="modalHeader" aria-modal="true">
      <div class="modal-content">
        <div id="modalHeader" class="modal-header"></div>
        <div id="modalBody" class="modal-body"></div>
        <div class="modal-footer">
          <button class="modal-button primary" onclick="closeModal()">Got it</button>
        </div>
      </div>
    </div>

    <script>
      // Detect which scenario is running by checking API
      let currentScenario = 'htid'; // Default

      // Scenario metadata
      const scenarioData = {
        'htid': {
          name: 'üéµ HTID (Hardstyle Til I Die)',
          emoji: 'üéµ',
          description: 'Single-day festival - Manageable demand, service met expectations',
          staff: '6 peers, 6 chemists',
          outcome: 'SUCCESS',
          command: 'python demo_server.py --scenario htid'
        },
        'lost_paradise_actual': {
          name: 'üå¥ Lost Paradise (Actual - Understaffed)',
          emoji: 'üå¥',
          description: 'Multi-day festival - CRITICAL capacity crisis with same staffing',
          staff: '6 peers, 6 chemists (SAME AS HTID!)',
          outcome: 'CAPACITY CRISIS',
          command: 'python demo_server.py --scenario lost_paradise_actual'
        },
        'lost_paradise_ideal': {
          name: 'üåü Lost Paradise (Ideal - Proper Staffing)',
          emoji: 'üåü',
          description: 'Multi-day festival - Doubled staff, everyone served',
          staff: '12 peers, 12 chemists (DOUBLED!)',
          outcome: 'SUCCESS',
          command: 'python demo_server.py --scenario lost_paradise_ideal'
        }
      };

      // Try to detect scenario from session ID in API
      async function detectScenario() {
        try {
          const response = await fetch('/health');
          
          if (!response.ok) {
            console.log('Could not fetch health endpoint, using default scenario');
            updateCurrentScenarioDisplay();
            return;
          }
          
          const data = await response.json();
          const sessionId = data?.session || data?.session_id || '';

          if (sessionId.includes('htid')) {
            currentScenario = 'htid';
          } else if (sessionId.includes('lost-paradise-actual')) {
            currentScenario = 'lost_paradise_actual';
          } else if (sessionId.includes('lost-paradise-ideal')) {
            currentScenario = 'lost_paradise_ideal';
          }

          updateCurrentScenarioDisplay();
        } catch (error) {
          console.log('Could not detect scenario, using default:', error);
          updateCurrentScenarioDisplay();
        }
      }

      function updateCurrentScenarioDisplay() {
        const scenario = scenarioData[currentScenario];
        const card = document.getElementById('current-scenario-card');
        const badge = document.getElementById('scenario-badge');

        // Update header badge
        badge.textContent = scenario.emoji + ' ' + scenario.outcome;
        if (currentScenario === 'htid' || currentScenario === 'lost_paradise_ideal') {
          badge.style.background = 'rgba(16, 185, 129, 0.2)'; // Green
        } else {
          badge.style.background = 'rgba(220, 38, 38, 0.2)'; // Red
        }

        // Show current scenario card
        card.style.display = 'block';
        document.getElementById('current-scenario-name').textContent = scenario.name;
        document.getElementById('current-scenario-desc').textContent = scenario.description;

        const statsDiv = document.getElementById('current-scenario-stats');
        statsDiv.innerHTML = `
          <p style="margin: 5px 0;"><strong>Staff:</strong> ${scenario.staff}</p>
          <p style="margin: 10px 0 5px 0;"><strong>To view other scenarios:</strong></p>
          <p style="margin: 5px 0; font-size: 0.9em;">
            ‚Ä¢ <strong>Deployed demo:</strong> Ask for the other scenario URLs<br>
            ‚Ä¢ <strong>Local testing:</strong> Stop server (Ctrl+C) and run:<br>
          </p>
          <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-top: 8px; font-family: monospace; font-size: 0.85em;">
            ${scenario.command}
          </div>
          <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
            üí° <strong>Tip:</strong> Deploy all 3 scenarios to separate Render instances for easy side-by-side comparison!
          </p>
        `;

        // Highlight the current scenario card
        highlightCurrentScenarioCard();
      }

      function highlightCurrentScenarioCard() {
        const cards = document.querySelectorAll('.scenario-card');
        cards.forEach(card => {
          const scenario = card.getAttribute('data-scenario');
          const btn = card.querySelector('.btn');

          if (scenario === currentScenario) {
            // This is the running scenario
            card.style.border = '3px solid #ffd700';
            card.style.boxShadow = '0 15px 40px rgba(255, 215, 0, 0.4)';
            btn.textContent = '‚úì Currently Running';
            btn.style.background = '#ffd700';
            btn.style.color = '#000';
            btn.style.cursor = 'default';
          } else {
            // Other scenarios
            card.style.border = '3px solid transparent';
            card.style.opacity = '0.7';
            const scenarioInfo = scenarioData[scenario];
            btn.textContent = 'Learn How to Switch ‚Üí';

            // Add click handler to show instructions
            card.style.cursor = 'pointer';
            card.onclick = () => {
              showModal(
                `Switch to ${scenarioInfo.name}`,
                `<p><strong>To view this scenario:</strong></p>
                 <p style="margin-top: 10px;">1. <strong>If deployed:</strong> Visit the dedicated URL for this scenario</p>
                 <p style="margin-top: 8px;">2. <strong>If local:</strong> Stop the server (Ctrl+C) and run:</p>
                 <div class="modal-code">${scenarioInfo.command}</div>
                 <p style="margin-top: 10px; font-style: italic;">üí° <strong>Tip:</strong> Deploy all 3 scenarios separately for instant switching!</p>`
              );
            };
          }
        });
      }

      // Modal functions
      let lastFocusedElement = null;
      
      function showModal(title, body) {
        const modal = document.getElementById('scenarioModal');
        const closeButton = modal.querySelector('.modal-button');
        
        // Store the currently focused element
        lastFocusedElement = document.activeElement;
        
        // Use textContent for title to prevent XSS
        document.getElementById('modalHeader').textContent = title;
        
        // Note: Using innerHTML here is safe because the body content is controlled by us
        // (scenario data from scenarioData object) and never includes user input.
        // The command string is hardcoded in the scenarioData object.
        document.getElementById('modalBody').innerHTML = body;
        
        modal.classList.add('active');
        
        // Focus the close button
        setTimeout(() => {
          closeButton.focus();
        }, 100);
        
        // Trap focus within modal
        trapFocusInModal(modal);
        
        // Close on overlay click
        modal.onclick = (e) => {
          if (e.target === modal) {
            closeModal();
          }
        };
        
        // Close on Escape key
        document.addEventListener('keydown', handleEscapeKey);
      }

      function closeModal() {
        const modal = document.getElementById('scenarioModal');
        modal.classList.remove('active');
        document.removeEventListener('keydown', handleEscapeKey);
        
        // Return focus to the element that opened the modal
        if (lastFocusedElement) {
          lastFocusedElement.focus();
        }
      }

      function handleEscapeKey(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      }
      
      function trapFocusInModal(modal) {
        const focusableElements = modal.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstFocusable = focusableElements[0];
        const lastFocusable = focusableElements[focusableElements.length - 1];

        modal.addEventListener('keydown', function(e) {
          if (e.key !== 'Tab') return;

          if (e.shiftKey) {
            if (document.activeElement === firstFocusable) {
              lastFocusable.focus();
              e.preventDefault();
            }
          } else {
            if (document.activeElement === lastFocusable) {
              firstFocusable.focus();
              e.preventDefault();
            }
          }
        });
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        detectScenario();
      });

      // Update stats from API
      async function updateStats() {
        try {
          const response = await fetch('/api/stats');
          const data = await response.json();

          document.getElementById('active-count').textContent = data.participants_in_service || '0';
          document.getElementById('queue-count').textContent = data.queue_length || '0';
          document.getElementById('total-count').textContent = data.total_participants || '0';

          const waitMinutes = data.estimated_wait_minutes;
          document.getElementById('wait-time').textContent = waitMinutes !== undefined ? waitMinutes : '-';
        } catch (error) {
          console.error('Error updating stats:', error);
        }
      }

      // Update every 5 seconds
      updateStats();
      setInterval(updateStats, 5000);
    </script>
  </body>
</html>
