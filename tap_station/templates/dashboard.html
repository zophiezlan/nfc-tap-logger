<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Dashboard - {{ session }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header .session-info {
            opacity: 0.9;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card .label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }

        .stat-card .sub-value {
            font-size: 14px;
            color: #999;
            margin-top: 5px;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-card.highlight .label,
        .stat-card.highlight .value,
        .stat-card.highlight .sub-value {
            color: white;
        }

        .stat-card.highlight .sub-value {
            opacity: 0.9;
        }

        .two-column {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .activity-chart {
            height: 200px;
            margin-top: 10px;
        }

        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 150px;
            border-bottom: 2px solid #eee;
            padding: 10px 0;
        }

        .chart-bar {
            flex: 1;
            margin: 0 2px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-width: 20px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar .value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #667eea;
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 11px;
            color: #999;
        }

        .chart-labels .label {
            flex: 1;
            text-align: center;
            margin: 0 2px;
        }

        .recent-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .recent-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .recent-item .token {
            font-weight: 600;
            color: #667eea;
        }

        .recent-item .wait-time {
            font-size: 14px;
            color: #666;
        }

        .recent-item .wait-time.good {
            color: #10b981;
        }

        .recent-item .wait-time.medium {
            color: #f59e0b;
        }

        .recent-item .wait-time.long {
            color: #ef4444;
        }

        .event-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            padding: 10px 12px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            background: #f9fafb;
            border-radius: 0 4px 4px 0;
            font-size: 13px;
        }

        .event-item .time {
            color: #999;
            font-size: 11px;
            margin-bottom: 3px;
        }

        .event-item .stage {
            font-weight: 600;
            margin-right: 8px;
        }

        .event-item.join {
            border-left-color: #10b981;
        }

        .event-item.exit {
            border-left-color: #ef4444;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.join {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.exit {
            background: #fee2e2;
            color: #991b1b;
        }

        .auto-refresh {
            text-align: center;
            padding: 10px;
            color: #999;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .pulse {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .export-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .export-button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span class="pulse"></span> Live Dashboard</h1>
        <div class="session-info">
            Session: {{ session }} | Station: {{ device_id }} ({{ stage }})
        </div>
    </div>

    <div class="container">
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="label">In Queue</div>
                <div class="value" id="in-queue">-</div>
                <div class="sub-value">people waiting</div>
            </div>

            <div class="stat-card">
                <div class="label">Avg Wait Time</div>
                <div class="value" id="avg-wait">-</div>
                <div class="sub-value">minutes</div>
            </div>

            <div class="stat-card">
                <div class="label">Completed Today</div>
                <div class="value" id="completed-today">-</div>
                <div class="sub-value">people served</div>
            </div>

            <div class="stat-card">
                <div class="label">Last Hour</div>
                <div class="value" id="last-hour">-</div>
                <div class="sub-value">events</div>
            </div>

            <div class="stat-card">
                <div class="label">Total Events</div>
                <div class="value" id="today-events">-</div>
                <div class="sub-value">today</div>
            </div>

            <div class="stat-card">
                <div class="label">Throughput</div>
                <div class="value" id="throughput">-</div>
                <div class="sub-value">per hour</div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="two-column">
            <!-- Activity Chart -->
            <div class="card">
                <h2>Activity (Last 12 Hours)</h2>
                <div class="activity-chart">
                    <div class="chart-bar-container" id="chart-container">
                        <div class="loading">Loading chart...</div>
                    </div>
                    <div class="chart-labels" id="chart-labels"></div>
                </div>
            </div>

            <!-- Recent Completions -->
            <div class="card">
                <h2>Recent Completions</h2>
                <div class="recent-list" id="recent-completions">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Event Feed -->
        <div class="card">
            <h2>Live Event Feed</h2>
            <div class="event-feed" id="event-feed">
                <div class="loading">Loading events...</div>
            </div>
        </div>

        <div class="auto-refresh">
            Auto-refreshing every 5 seconds | Last update: <span id="last-update">-</span>
        </div>
    </div>

    <script>
        // Auto-refresh every 5 seconds
        let refreshInterval;

        async function fetchDashboardData() {
            try {
                const response = await fetch('/api/dashboard');
                const data = await response.json();

                updateDashboard(data);
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
            }
        }

        function updateDashboard(data) {
            // Update statistics
            const stats = data.stats;
            document.getElementById('in-queue').textContent = stats.in_queue;
            document.getElementById('avg-wait').textContent = stats.avg_wait_minutes;
            document.getElementById('completed-today').textContent = stats.completed_today;
            document.getElementById('last-hour').textContent = stats.last_hour_events;
            document.getElementById('today-events').textContent = stats.today_events;
            document.getElementById('throughput').textContent = Math.round(stats.throughput_per_hour);

            // Update activity chart
            updateChart(data.hourly_activity);

            // Update recent completions
            updateRecentCompletions(data.recent_completions);

            // Update event feed
            updateEventFeed(data.recent_events);
        }

        function updateChart(hourlyData) {
            if (!hourlyData || hourlyData.length === 0) {
                document.getElementById('chart-container').innerHTML = '<div class="loading">No data yet</div>';
                return;
            }

            const maxCount = Math.max(...hourlyData.map(h => h.count), 1);
            const container = document.getElementById('chart-container');
            const labelsDiv = document.getElementById('chart-labels');

            container.innerHTML = '';
            labelsDiv.innerHTML = '';

            hourlyData.forEach(item => {
                const height = (item.count / maxCount) * 100;
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = height + '%';
                bar.innerHTML = `<div class="value">${item.count}</div>`;
                container.appendChild(bar);

                const label = document.createElement('div');
                label.className = 'label';
                label.textContent = item.hour;
                labelsDiv.appendChild(label);
            });
        }

        function updateRecentCompletions(completions) {
            const container = document.getElementById('recent-completions');

            if (!completions || completions.length === 0) {
                container.innerHTML = '<div class="loading">No completions yet</div>';
                return;
            }

            container.innerHTML = completions.map(c => {
                let waitClass = 'good';
                if (c.wait_minutes > 30) waitClass = 'long';
                else if (c.wait_minutes > 15) waitClass = 'medium';

                return `
                    <div class="recent-item">
                        <div>
                            <span class="token">Token ${c.token_id}</span>
                            <div style="font-size: 12px; color: #999; margin-top: 3px;">Exited ${c.exit_time}</div>
                        </div>
                        <div class="wait-time ${waitClass}">${c.wait_minutes} min</div>
                    </div>
                `;
            }).join('');
        }

        function updateEventFeed(events) {
            const container = document.getElementById('event-feed');

            if (!events || events.length === 0) {
                container.innerHTML = '<div class="loading">No events yet</div>';
                return;
            }

            container.innerHTML = events.map(e => {
                const stageClass = e.stage === 'QUEUE_JOIN' ? 'join' : 'exit';
                const stageName = e.stage === 'QUEUE_JOIN' ? 'Queue Join' : 'Exit';

                return `
                    <div class="event-item ${stageClass}">
                        <div class="time">${e.time}</div>
                        <span class="badge ${stageClass}">${stageName}</span>
                        <span>Token ${e.token_id}</span>
                        <span style="color: #999; margin-left: 8px;">${e.device_id}</span>
                    </div>
                `;
            }).join('');
        }

        // Initial load
        fetchDashboardData();

        // Auto-refresh
        refreshInterval = setInterval(fetchDashboardData, 5000);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
